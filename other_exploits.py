import mariadb
import dbconnect
import traceback

# Creating a function that allow hackers to view other hackers' exploits
def view_other_exploits(hacker_id):
    # Connecting to the database and creating a cursor, checking to see if there is a successful database connection and whether the cursor was created
    conn = dbconnect.open_db_connection()
    cursor = dbconnect.create_db_cursor(conn)

    # If the connection to the database is successful but the cursor was not created, try to close the cursor and database connection, don't run the next lines of code
    if(conn == None or cursor == None):
        print("An error in the database has occured.")
        dbconnect.close_cursor(cursor)
        dbconnect.close_db_connection(conn)
        return

    # Using a try-except block to catch errors when a hacker tries to view their exploits
    try:
        # Getting all exploits from the database that do not belong to the logged in hacker
        cursor.execute("SELECT h.alias, e.content FROM cli_social_media.hackers h INNER JOIN cli_social_media.exploits e ON e.hacker_id = h.id WHERE h.id != ?", [hacker_id])
        other_exploits = cursor.fetchall()

        # If there are no exploits found, print a message to the hacker
        if(len(other_exploits) == 0):
            print("\nNo posts found.\n")
        # If there are more than one exploit found, print each hacker's exploit number, username, exploit and id
        else:
            print("\nOther Exploits")
            print("--------------")
            for exploit in other_exploits:
                print(f"\nExploit Written by @{exploit[0]}\n")
                print(f"{exploit[1]}\n")
                print("------------------------------")
    # If errors occurs during this process, raise the following exceptions, print an error message to the hacker and the traceback
    except mariadb.IntegrityError:
        # An IntegrityError is raised if there is any constraint failure such as a foreign key constraint failure
        print(f"\nErrors found in database due to foreign key contraint failure. Failed to retrieve exploits.\n")
        traceback.print_exc()
    except mariadb.OperationalError:
        # An OptionalError exception is raised for things that are not in control of the programmer such as an unexpected connection failure, server hutting down, etc.
        print(f"\nOperational errors detected in the database. Failed to retrieve exploits.\n")
        traceback.print_exc()
    except mariadb.ProgrammingError:
        # A ProgrammingError exception is raised if there are errors made by the programmer such as incorrect SQL syntax, getting data from a table that is not found, etc. 
        print("\nInvalid SQL syntax.\n")
        traceback.print_exc()
    except mariadb.NotSupportedError:
        # A NotSupportedError exception is raised if a programmer writes code that is not supported by a certain method such as a MariaDB syntax error
        print("\nInvalid MariaDB syntax.\n")
        traceback.print_exc() 
    except mariadb.DatabaseError:
        # A DatabaseError exception is raised for all errors that are related to the database
        print(f"\nAn error has occured in the database. Failed to retrieve exploits.\n")
        traceback.print_exc()
    except mariadb.InterfaceError:
        # An InterfaceError exception is raised if there are errors found in python or the database client
        print("\nAn interface error has occured. Please check the documentation for Python or the database client.\n")
        traceback.print_exc()
    except:
        # Catching all other errors
        print("\nAn error has occurred.\n")
        traceback.print_exc()

    # Closing the cursor and the database connection
    closing_cursor = dbconnect.close_cursor(cursor)
    closing_db = dbconnect.close_db_connection(conn)

    # If the cursor or database connection failed to close, print an error message
    if(closing_cursor == False or closing_db == False):
        print("\nFailed to close cursor and database connection.")